# Story 1.1: SKEL-DB-001 - Minimal Database Schema

## Status

Done

## Story

**As a** developer,
**I want** a minimal database schema for the core booking flow,
**so that** the application has the foundational data structures needed for Epic 0 functionality.

## Acceptance Criteria

1. Tables created: `users`, `user_profiles`, `availability`, `time_slots`, `bookings`
2. Basic columns only (no soft deletes, no reputation fields, no calendar integrations yet)
3. Timestamp columns (`created_at`, `updated_at`) auto-populated
4. Foreign keys and basic indexes
5. Simple RLS: Users can only read/update own data

## Tasks / Subtasks

- [x] Task 1: Create Supabase Migration File (AC: 1, 2, 3, 4)
  - [x] Run `supabase migration new minimal-database-schema` to create migration file
  - [x] Verify migration file created in `supabase/migrations/` directory
  - [x] Document migration naming convention in comments

- [x] Task 2: Define `users` Table (AC: 1, 2, 3, 4)
  - [x] Create `users` table with columns: `id` (uuid primary key), `airtable_record_id` (text unique), `email` (text unique), `role` (text check constraint: mentee/mentor/coordinator), `created_at` (timestamptz default now()), `updated_at` (timestamptz default now())
  - [x] Add index on `email` for fast lookup
  - [x] Add index on `airtable_record_id` for sync operations
  - [x] Create trigger for auto-updating `updated_at` on row modification
  - [x] Source: [architecture/4-data-models.md#4.1]

- [x] Task 3: Define `user_profiles` Table (AC: 1, 2, 3, 4)
  - [x] Create `user_profiles` table with columns: `id` (uuid primary key), `user_id` (uuid references users.id), `name` (text not null), `title` (text), `company` (text), `phone` (text), `bio` (text), `created_at` (timestamptz default now()), `updated_at` (timestamptz default now())
  - [x] Add foreign key constraint: `user_id` references `users(id)` ON DELETE CASCADE
  - [x] Add unique constraint on `user_id` (1:1 relationship)
  - [x] Create trigger for auto-updating `updated_at`
  - [x] Source: [architecture/4-data-models.md#4.1]

- [x] Task 4: Define `availability` Table (AC: 1, 2, 3, 4)
  - [x] Create `availability` table (renamed from `availability_blocks` for simplicity) with columns: `id` (uuid primary key), `mentor_id` (uuid references users.id), `start_date` (date not null), `end_date` (date), `start_time` (time not null), `end_time` (time not null), `slot_duration_minutes` (integer not null check in (15,20,30,60)), `location` (text not null), `created_at` (timestamptz default now()), `updated_at` (timestamptz default now())
  - [x] Add foreign key constraint: `mentor_id` references `users(id)` ON DELETE CASCADE
  - [x] Add index on `mentor_id` for mentor's availability queries
  - [x] Create trigger for auto-updating `updated_at`
  - [x] Source: [architecture/4-data-models.md#4.3]
  - [x] Note: Simplified for Epic 0 - no recurrence patterns, meeting types, or buffer yet

- [x] Task 5: Define `time_slots` Table (AC: 1, 2, 3, 4)
  - [x] Create `time_slots` table with columns: `id` (uuid primary key), `availability_id` (uuid references availability.id), `mentor_id` (uuid references users.id), `start_time` (timestamptz not null), `end_time` (timestamptz not null), `is_booked` (boolean default false), `booking_id` (uuid nullable), `created_at` (timestamptz default now())
  - [x] Add foreign key constraint: `availability_id` references `availability(id)` ON DELETE CASCADE
  - [x] Add foreign key constraint: `mentor_id` references `users(id)` ON DELETE CASCADE
  - [x] Add index on `mentor_id` and `start_time` for slot browsing queries
  - [x] Add index on `is_booked` for available slot filtering
  - [x] Source: [architecture/4-data-models.md#4.3]

- [x] Task 6: Define `bookings` Table (AC: 1, 2, 3, 4)
  - [x] Create `bookings` table with columns: `id` (uuid primary key), `time_slot_id` (uuid references time_slots.id unique), `mentor_id` (uuid references users.id), `mentee_id` (uuid references users.id), `meeting_goal` (text not null), `location` (text not null), `status` (text default 'confirmed' check in ('confirmed','completed','canceled')), `meeting_start_time` (timestamptz not null), `meeting_end_time` (timestamptz not null), `created_at` (timestamptz default now()), `updated_at` (timestamptz default now())
  - [x] Add foreign key constraint: `time_slot_id` references `time_slots(id)` ON DELETE RESTRICT (prevent deletion of booked slots)
  - [x] Add foreign key constraint: `mentor_id` references `users(id)` ON DELETE CASCADE
  - [x] Add foreign key constraint: `mentee_id` references `users(id)` ON DELETE CASCADE
  - [x] Add unique constraint on `time_slot_id` (one booking per slot)
  - [x] Add index on `mentee_id` for mentee bookings queries
  - [x] Add index on `mentor_id` for mentor bookings queries
  - [x] Create trigger for auto-updating `updated_at`
  - [x] Source: [architecture/4-data-models.md#4.3]
  - [x] Note: Simplified for Epic 0 - no materials_urls, google_meet_link, cancellation fields yet

- [x] Task 7: Implement Simple Row Level Security Policies (AC: 5)
  - [x] Enable RLS on `users` table: `ALTER TABLE users ENABLE ROW LEVEL SECURITY;`
  - [x] Create RLS policy on `users`: Allow authenticated users to read their own row (`user_id = auth.uid()`)
  - [x] Create RLS policy on `users`: Allow authenticated users to update their own row
  - [x] Enable RLS on `user_profiles` table
  - [x] Create RLS policy on `user_profiles`: Allow authenticated users to read their own profile
  - [x] Create RLS policy on `user_profiles`: Allow authenticated users to update their own profile
  - [x] Create RLS policy on `user_profiles`: Allow public read for all profiles (needed for mentor discovery)
  - [x] Enable RLS on `availability` table
  - [x] Create RLS policy on `availability`: Allow mentors to CRUD their own availability
  - [x] Create RLS policy on `availability`: Allow public read for all availability (needed for slot browsing)
  - [x] Enable RLS on `time_slots` table
  - [x] Create RLS policy on `time_slots`: Allow public read for available slots
  - [x] Enable RLS on `bookings` table
  - [x] Create RLS policy on `bookings`: Allow users to read bookings where they are mentor OR mentee
  - [x] Create RLS policy on `bookings`: Allow mentees to create bookings
  - [x] Source: [architecture/4-data-models.md#4.1], [prd/2-requirements.md (NFR12)]
  - [x] Note: Simplified for Epic 0 - no coordinator role checks yet, added in Epic 1

- [x] Task 8: Apply Migration to Local Supabase (AC: 1-5)
  - [x] Run `supabase db push` to apply migration to local database
  - [x] Verify all tables created with `supabase db inspect`
  - [x] Confirm RLS policies enabled with Supabase Studio
  - [x] Test basic CRUD operations to verify constraints and indexes work
  - [x] Document rollback procedure in migration file comments

- [x] Task 9: Validate Schema Against Architecture (AC: 1-5)
  - [x] Verify all AC1 tables exist and are accessible
  - [x] Confirm no Epic 1+ fields present (soft deletes, reputation, calendar)
  - [x] Test auto-population of `created_at` and `updated_at` by creating test rows
  - [x] Verify foreign key relationships by attempting invalid inserts (should fail)
  - [x] Confirm RLS by attempting unauthorized access with test users (should fail)

## Dev Notes

### Minimal Schema Strategy

This story creates the **bare minimum database schema** required for Epic 0 (Walking Skeleton). The schema will be extended in Epic 1 (Infrastructure Depth) with:
- Soft delete columns (`deleted_at`)
- Reputation fields (`reputation_score`, `reputation_tier`, `last_activity_at`)
- Calendar integration fields (`calendar_integrations` table)
- Taxonomy tables (`taxonomy`, `user_tags`)
- Audit tables (`audit_log`, `reputation_history`)

**Walking Skeleton Principle:** Ship minimal working product first, add depth later.

[Source: docs/prd/5-epic-and-story-structure.md#5.2]

### Database Technology: Supabase PostgreSQL

**Database:** PostgreSQL (via Supabase managed instance)

**Key Features for This Story:**
- ACID compliance for transaction integrity
- Row Level Security (RLS) built-in for data protection
- Auto-generated timestamps via `DEFAULT now()`
- UUID primary keys via `gen_random_uuid()`
- Foreign key constraints with cascade options

**Supabase Management:**
- Schema changes via Supabase CLI migrations (`supabase migration new <name>`)
- Apply migrations: `supabase db push` (local), CI/CD for production
- Version control: Migration files stored in `supabase/migrations/`

[Source: docs/architecture/3-tech-stack.md#3.1]

### Data Model Details

**Users Table (Minimal):**
```sql
CREATE TABLE users (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  airtable_record_id text UNIQUE NOT NULL,
  email text UNIQUE NOT NULL,
  role text NOT NULL CHECK (role IN ('mentee', 'mentor', 'coordinator')),
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_airtable_record_id ON users(airtable_record_id);
```

**Key Decisions:**
- `airtable_record_id`: Stable external reference from Airtable (source of truth for users)
- `role`: Single role per user (enum check constraint)
- No `is_active`, `reputation_score`, `reputation_tier`, `last_activity_at` yet (added in Epic 1)

[Source: docs/architecture/4-data-models.md#4.1]

**User Profiles Table (Minimal):**
```sql
CREATE TABLE user_profiles (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name text NOT NULL,
  title text,
  company text,
  phone text,
  bio text,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
```

**Key Decisions:**
- 1:1 relationship with `users` (UNIQUE constraint on `user_id`)
- No `linkedin_url`, `website_url`, `pitch_vc_url`, `avatar_url`, `reminder_preference`, `additional_links`, `metadata` yet (added in Epic 2)
- No mentor/mentee-specific fields (`expertise_description`, `ideal_mentee_description`) yet (added in Epic 2)

[Source: docs/architecture/4-data-models.md#4.1]

**Availability Table (Minimal):**
```sql
CREATE TABLE availability (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  mentor_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  start_date date NOT NULL,
  end_date date,
  start_time time NOT NULL,
  end_time time NOT NULL,
  slot_duration_minutes integer NOT NULL CHECK (slot_duration_minutes IN (15, 20, 30, 60)),
  location text NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE INDEX idx_availability_mentor_id ON availability(mentor_id);
```

**Key Decisions:**
- Simplified from `availability_blocks` in full architecture
- `location` is simple text field (no `meeting_type`, `location_preset_id`, `location_custom` separation yet)
- No `recurrence_pattern`, `buffer_minutes`, `description` yet (added in Epic 4)
- Slot generation will create `time_slots` rows for specified date range

[Source: docs/architecture/4-data-models.md#4.3]

**Time Slots Table (Minimal):**
```sql
CREATE TABLE time_slots (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  availability_id uuid NOT NULL REFERENCES availability(id) ON DELETE CASCADE,
  mentor_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  start_time timestamptz NOT NULL,
  end_time timestamptz NOT NULL,
  is_booked boolean DEFAULT false,
  booking_id uuid,
  created_at timestamptz DEFAULT now()
);

CREATE INDEX idx_time_slots_mentor_start ON time_slots(mentor_id, start_time);
CREATE INDEX idx_time_slots_is_booked ON time_slots(is_booked);
```

**Key Decisions:**
- `start_time` and `end_time` are full UTC timestamps (includes date + time)
- `is_booked` flag for quick availability filtering
- `booking_id` nullable (set when slot is booked)
- No `deleted_at` yet (soft deletes added in Epic 1)

[Source: docs/architecture/4-data-models.md#4.3]

**Bookings Table (Minimal):**
```sql
CREATE TABLE bookings (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  time_slot_id uuid UNIQUE NOT NULL REFERENCES time_slots(id) ON DELETE RESTRICT,
  mentor_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  mentee_id uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  meeting_goal text NOT NULL,
  location text NOT NULL,
  status text DEFAULT 'confirmed' CHECK (status IN ('confirmed', 'completed', 'canceled')),
  meeting_start_time timestamptz NOT NULL,
  meeting_end_time timestamptz NOT NULL,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);

CREATE UNIQUE INDEX idx_bookings_time_slot_id ON bookings(time_slot_id);
CREATE INDEX idx_bookings_mentee_id ON bookings(mentee_id);
CREATE INDEX idx_bookings_mentor_id ON bookings(mentor_id);
```

**Key Decisions:**
- `time_slot_id` UNIQUE ensures one booking per slot
- No `materials_urls`, `google_meet_link` yet (added in Epic 3)
- No `canceled_by`, `canceled_at`, `cancellation_reason`, `cancellation_notes` yet (added in Epic 4)
- No `deleted_at` yet (soft deletes added in Epic 1)
- `meeting_start_time` and `meeting_end_time` denormalized for quick queries (copied from `time_slot`)

[Source: docs/architecture/4-data-models.md#4.3]

### Row Level Security (RLS) Policies

**Simplified RLS for Epic 0:**

All tables have RLS enabled, but policies are minimal:

**Users Table:**
```sql
ALTER TABLE users ENABLE ROW LEVEL SECURITY;

-- Allow users to read their own row
CREATE POLICY users_select_own ON users
  FOR SELECT
  USING (auth.uid() = id);

-- Allow users to update their own row
CREATE POLICY users_update_own ON users
  FOR UPDATE
  USING (auth.uid() = id);
```

**User Profiles Table:**
```sql
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

-- Allow public read (needed for mentor discovery)
CREATE POLICY user_profiles_select_all ON user_profiles
  FOR SELECT
  TO authenticated
  USING (true);

-- Allow users to update their own profile
CREATE POLICY user_profiles_update_own ON user_profiles
  FOR UPDATE
  USING (auth.uid() = user_id);
```

**Availability Table:**
```sql
ALTER TABLE availability ENABLE ROW LEVEL SECURITY;

-- Allow mentors to CRUD their own availability
CREATE POLICY availability_mentor_all ON availability
  TO authenticated
  USING (auth.uid() = mentor_id);

-- Allow public read for slot browsing
CREATE POLICY availability_select_all ON availability
  FOR SELECT
  TO authenticated
  USING (true);
```

**Time Slots Table:**
```sql
ALTER TABLE time_slots ENABLE ROW LEVEL SECURITY;

-- Allow public read for available slots
CREATE POLICY time_slots_select_all ON time_slots
  FOR SELECT
  TO authenticated
  USING (true);
```

**Bookings Table:**
```sql
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;

-- Allow users to read bookings where they are mentor OR mentee
CREATE POLICY bookings_select_own ON bookings
  FOR SELECT
  TO authenticated
  USING (auth.uid() = mentor_id OR auth.uid() = mentee_id);

-- Allow mentees to create bookings
CREATE POLICY bookings_insert_mentee ON bookings
  FOR INSERT
  TO authenticated
  WITH CHECK (auth.uid() = mentee_id);
```

**Coordinator Role Policies:**
Not implemented in Epic 0. Epic 1 will add coordinator override policies allowing full data access.

[Source: docs/architecture/4-data-models.md#4.1, Section 13.3.1 (Integration Testing)]

### Auto-Update Triggers for Timestamps

**Pattern for `updated_at` Auto-Update:**

```sql
-- Create trigger function (only once for entire database)
CREATE OR REPLACE FUNCTION trigger_set_timestamp()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply trigger to each table with updated_at
CREATE TRIGGER set_timestamp_users
BEFORE UPDATE ON users
FOR EACH ROW
EXECUTE FUNCTION trigger_set_timestamp();

CREATE TRIGGER set_timestamp_user_profiles
BEFORE UPDATE ON user_profiles
FOR EACH ROW
EXECUTE FUNCTION trigger_set_timestamp();

-- ... repeat for availability, bookings
```

This ensures `updated_at` is automatically set whenever a row is modified, without application code needing to manage it.

[Source: PostgreSQL best practices for timestamp management]

### Foreign Key Relationships

**Cascade Rules:**
- `users` → `user_profiles`: CASCADE (delete profile when user deleted)
- `users` → `availability`: CASCADE (delete availability when mentor user deleted)
- `users` → `time_slots`: CASCADE (delete slots when mentor user deleted)
- `availability` → `time_slots`: CASCADE (delete slots when availability block deleted)
- `time_slots` → `bookings`: RESTRICT (prevent deletion of booked slots)
- `users` → `bookings` (mentor/mentee): CASCADE (delete bookings when user deleted)

**Rationale:**
- RESTRICT on `time_slots` → `bookings` prevents accidental deletion of booked slots
- CASCADE on user deletions ensures orphaned data is cleaned up
- Soft deletes (Epic 1) will replace CASCADE with status updates

[Source: docs/architecture/4-data-models.md#4.3]

### Index Strategy

**Indexes for Epic 0:**

```sql
-- Users table
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_airtable_record_id ON users(airtable_record_id);

-- User profiles table
CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);

-- Availability table
CREATE INDEX idx_availability_mentor_id ON availability(mentor_id);

-- Time slots table
CREATE INDEX idx_time_slots_mentor_start ON time_slots(mentor_id, start_time);
CREATE INDEX idx_time_slots_is_booked ON time_slots(is_booked);

-- Bookings table
CREATE UNIQUE INDEX idx_bookings_time_slot_id ON bookings(time_slot_id);
CREATE INDEX idx_bookings_mentee_id ON bookings(mentee_id);
CREATE INDEX idx_bookings_mentor_id ON bookings(mentor_id);
```

**Rationale:**
- `email` and `airtable_record_id` indexed for auth and sync lookups
- `mentor_id` + `start_time` composite index for slot browsing queries (common: "show me mentor X's slots starting after date Y")
- `is_booked` index for filtering available slots
- `time_slot_id` unique index enforces one booking per slot

[Source: docs/architecture/4-data-models.md#4.3, Section 14.12 (Performance Best Practices)]

### Migration File Structure

**Location:** `supabase/migrations/`

**Naming Convention:** `<timestamp>_minimal_database_schema.sql`

**Migration File Contents:**
1. Table definitions (CREATE TABLE statements)
2. Index definitions (CREATE INDEX statements)
3. Trigger function and triggers (CREATE FUNCTION, CREATE TRIGGER)
4. RLS policies (ALTER TABLE ... ENABLE ROW LEVEL SECURITY, CREATE POLICY)
5. Comments documenting Epic 0 scope and Epic 1 extensions

**Rollback Procedure:**
Document rollback commands in comments:
```sql
-- Rollback (if needed):
-- DROP TABLE IF EXISTS bookings CASCADE;
-- DROP TABLE IF EXISTS time_slots CASCADE;
-- DROP TABLE IF EXISTS availability CASCADE;
-- DROP TABLE IF EXISTS user_profiles CASCADE;
-- DROP TABLE IF EXISTS users CASCADE;
-- DROP FUNCTION IF EXISTS trigger_set_timestamp() CASCADE;
```

[Source: docs/architecture/10-development-workflow.md#10.1.6 (Database Migrations)]

### Testing

Since this is a database schema creation story, testing focuses on schema validation and constraint enforcement:

**Schema Validation Tests:**
- Verify all required tables exist in database
- Confirm all columns have correct types and constraints
- Validate indexes created successfully
- Check RLS policies enabled on all tables

**Constraint Tests:**
- Test foreign key constraints (attempt invalid inserts, should fail)
- Test unique constraints (attempt duplicate emails, should fail)
- Test check constraints (attempt invalid `role` value, should fail)
- Test NOT NULL constraints (attempt null inserts, should fail)

**RLS Policy Tests:**
- Test authenticated user can read their own user/profile data
- Test user cannot read other users' data (unless coordinator)
- Test mentee can create booking for themselves
- Test user cannot create booking for another user
- Test public read access to profiles and availability

**Timestamp Auto-Update Tests:**
- Insert test row, verify `created_at` set automatically
- Update test row, verify `updated_at` changed
- Verify `created_at` did NOT change on update

**No Unit Tests Required:** This story has no business logic to test (schema only).

[Source: docs/architecture/13-testing-strategy.md#13.3 (Integration Testing)]

**Testing Location:**
Integration tests will be added in future stories when API endpoints interact with these tables. For this story, manual verification via Supabase Studio and SQL queries is sufficient.

[Source: docs/architecture/13-testing-strategy.md#13.11 (Test Coverage by Epic)]

## Change Log

| Date       | Version | Description          | Author         |
| ---------- | ------- | -------------------- | -------------- |
| 2025-10-03 | 1.0     | Initial story draft  | SM Agent (Bob) |
| 2025-10-03 | 1.1     | Applied QA fixes: Added FK constraint on time_slots.booking_id (DATA-001), Added CHECK constraints for time/date validation (VALID-001) | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (via Cursor)

### Debug Log References

**Initial Implementation:**
- Initial migration push attempted to target remote database instead of local
- Resolved by using `supabase db reset --yes` to properly apply migration to local instance

**QA Fix Application (2025-10-03):**
- Applied QA fixes from gate review (docs/qa/gates/1.1-minimal-database-schema.yml)
- Fixed FK constraint ordering issue (bookings table must exist before referencing it)
- Verified all constraints with test queries

### Completion Notes List

1. **Migration File Created**: `supabase/migrations/20251003041821_minimal_database_schema.sql`
   - Contains all 5 tables with complete schema definitions
   - Includes comprehensive comments documenting Epic 0 scope and future Epic extensions
   - Rollback instructions documented in migration file

2. **Schema Validation Completed**:
   - ✅ 5 tables created (users, user_profiles, availability, time_slots, bookings)
   - ✅ 13 indexes created (11 explicit + 2 unique constraint indexes)
   - ✅ 4 triggers created for auto-updating `updated_at`
   - ✅ 11 RLS policies created across all tables
   - ✅ 7 foreign key constraints with appropriate CASCADE/RESTRICT rules

3. **Functionality Testing**:
   - ✅ Timestamp auto-population verified (created_at and updated_at)
   - ✅ Trigger function verified (updated_at changes on row updates)
   - ✅ Check constraints validated (role enum rejection)
   - ✅ Foreign key constraints validated (referential integrity enforced)
   - ✅ Unique constraints validated (duplicate prevention)

4. **RLS Policies Implemented**:
   - Users: Self-read/update policies
   - User Profiles: Public read + self-update + self-insert
   - Availability: Mentor full CRUD + public read
   - Time Slots: Public read (write controlled via application)
   - Bookings: Participant read/update + mentee insert

5. **All Acceptance Criteria Met**:
   - AC1: ✅ All 5 tables created
   - AC2: ✅ Basic columns only (no Epic 1+ fields)
   - AC3: ✅ Timestamps auto-populated
   - AC4: ✅ Foreign keys and indexes in place
   - AC5: ✅ Simple RLS policies enabled

6. **QA Fixes Applied (2025-10-03)**:
   - ✅ **DATA-001 (Medium)**: Added FK constraint on `time_slots.booking_id` → `bookings(id)` ON DELETE SET NULL
     - Prevents orphaned booking_id values
     - Ensures referential integrity
   - ✅ **VALID-001 (Low)**: Added CHECK constraints for time/date validation
     - `availability`: end_time > start_time, end_date >= start_date (or NULL)
     - `time_slots`: end_time > start_time
     - `bookings`: meeting_end_time > meeting_start_time
   - ✅ All constraints tested and verified working correctly

### File List

**Created:**
- `supabase/migrations/20251003041821_minimal_database_schema.sql` - Complete database schema migration

**Modified:**
- `docs/stories/1.1.story.md` - Updated task checkboxes, Dev Agent Record section, and QA fix notes
- `supabase/migrations/20251003041821_minimal_database_schema.sql` - Applied QA fixes (FK constraint, CHECK constraints)

## QA Results

### Review Date: 2025-10-03 (Updated after QA fixes applied)

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment:** The database schema implementation is well-structured, thoroughly documented, and appropriately scoped for Epic 0 (Walking Skeleton). The migration file demonstrates excellent practices with clear section organization, comprehensive comments documenting future extensions, and appropriate rollback instructions.

**Strengths:**
- ✅ Clear separation of concerns with logical table grouping
- ✅ Comprehensive inline documentation including Epic scope and future field additions
- ✅ Proper index strategy aligned with expected query patterns (composite indexes on mentor_id + start_time)
- ✅ Appropriate foreign key cascade rules (CASCADE for cleanup, RESTRICT for data protection)
- ✅ Auto-updating timestamp triggers implemented correctly
- ✅ RLS policies appropriate for Epic 0 scope

**Schema Design Quality:**
- Tables correctly normalized (1:1 for user_profiles, proper referential integrity)
- UUID primary keys with gen_random_uuid() defaults
- Timestamptz types for proper UTC timezone handling
- Check constraints for enum validation (role, status, slot_duration_minutes)
- Unique constraints prevent duplicate bookings (time_slot_id in bookings table)

### ✅ QA Issues Resolved (All Issues Addressed)

**UPDATE (2025-10-03):** Developer has successfully addressed all identified concerns:

**DATA-001 (Medium Priority) - RESOLVED ✅**
- **Issue:** Missing FK constraint on `time_slots.booking_id`
- **Resolution:** Added `ALTER TABLE time_slots ADD CONSTRAINT fk_time_slots_booking FOREIGN KEY (booking_id) REFERENCES bookings(id) ON DELETE SET NULL;`
- **Location:** Lines 184-188 in migration file
- **Impact:** Data integrity now fully enforced at database level

**VALID-001 (Low Priority - Optional Enhancements) - RESOLVED ✅**
- **Issue:** Missing CHECK constraints for time/date validation
- **Resolution:** Added all three CHECK constraints:
  - `availability`: `chk_availability_time_range` (end_time > start_time) - Line 104
  - `availability`: `chk_availability_date_range` (end_date >= start_date OR NULL) - Line 105
  - `time_slots`: `chk_time_slots_time_range` (end_time > start_time) - Line 133
  - `bookings`: `chk_bookings_meeting_time_range` (meeting_end_time > meeting_start_time) - Line 160
- **Impact:** Additional database-level validation layer ensures data quality

**Documentation Quality:**
- Developer added clear QA fix section with issue references
- Explained FK constraint placement (after bookings table creation due to forward reference)
- Updated Change Log and Dev Agent Record with fix details

### Refactoring Performed

**Initial Review (2025-10-03):** No refactoring performed - provided recommendations for developer to implement.

**Post-Fix Review (2025-10-03):** Developer successfully applied all recommended fixes:
- Added FK constraint with proper ON DELETE SET NULL behavior
- Added CHECK constraints for time/date validation across three tables
- Documented changes with clear QA issue references
- No further refactoring needed

### Compliance Check

- **Coding Standards:** ✅ SQL follows clear formatting, consistent naming conventions (snake_case), proper indentation
- **Project Structure:** ✅ Migration file in correct location (`supabase/migrations/`) with timestamp prefix
- **Testing Strategy:** ✅ Appropriate for Epic 0 - manual verification documented in Tasks 8-9, integration tests deferred to API story per architecture doc 13.3
- **All ACs Met:** ✅ All 5 acceptance criteria validated and documented in Dev Agent Record
- **Data Integrity:** ✅ All FK constraints in place (8 total including time_slots.booking_id)
- **Validation Layer:** ✅ CHECK constraints provide database-level validation (4 constraints across 3 tables)

### Requirements Traceability (Given-When-Then Coverage)

**AC1: Tables created**
- **Given:** Migration SQL contains CREATE TABLE statements
- **When:** Migration is applied via `supabase db push`
- **Then:** 5 tables exist in database (users, user_profiles, availability, time_slots, bookings)
- **Coverage:** ✓ Verified in Task 8 via `supabase db inspect`

**AC2: Basic columns only**
- **Given:** Epic 0 scope limits fields to minimal set
- **When:** Migration is applied
- **Then:** No Epic 1+ fields present (soft deletes, reputation, calendar integrations)
- **Coverage:** ✓ Verified in Task 9, documented in table comments

**AC3: Timestamp auto-population**
- **Given:** Trigger function trigger_set_timestamp() exists
- **When:** Row is created or updated
- **Then:** created_at set on INSERT, updated_at modified on UPDATE
- **Coverage:** ✓ Verified in Task 9 via test row creation/updates

**AC4: Foreign keys and indexes**
- **Given:** Migration defines 7 FK constraints and 13 indexes
- **When:** Migration is applied
- **Then:** Referential integrity enforced, query performance optimized
- **Coverage:** ✓ Verified in Task 9 via invalid insert attempts (FK validation)

**AC5: Simple RLS policies**
- **Given:** 11 RLS policies defined across 5 tables
- **When:** Authenticated users query tables
- **Then:** Users read/write only their own data (except public read for profiles/availability/slots)
- **Coverage:** ✓ Verified in Task 9 via unauthorized access attempts

### Testing Assessment

**Test Coverage: Manual Verification (Appropriate for Epic 0)**

This database schema story correctly uses manual verification instead of automated tests, following the testing strategy document (Section 13.3):

> "Testing Location: Integration tests will be added in future stories when API endpoints interact with these tables. For this story, manual verification via Supabase Studio and SQL queries is sufficient."

**Manual Test Execution (Documented in Tasks 8-9):**
- ✓ Schema existence validation (`supabase db inspect`)
- ✓ Constraint enforcement tests (invalid inserts)
- ✓ Timestamp auto-update tests (create/update test rows)
- ✓ Foreign key cascade tests (deletion attempts)
- ✓ RLS policy tests (unauthorized access attempts)

**Future Test Recommendations (Epic 1+):**
When API endpoints are built, add integration tests for:
- RLS policy enforcement via API requests
- Concurrent booking race conditions (NFR7)
- Soft delete query filtering
- Constraint violation error handling

### Security Review

**RLS Policies: Appropriate for Epic 0**

All 5 tables have RLS enabled with 11 policies total:

**Users Table:**
- ✓ users_select_own: Users read their own row only
- ✓ users_update_own: Users update their own row only
- ⚠️ No INSERT policy (users created via Airtable sync - intentional)

**User Profiles Table:**
- ✓ user_profiles_select_all: Public read access (needed for mentor discovery per FR15)
- ✓ user_profiles_update_own: Self-update only
- ✓ user_profiles_insert_own: Self-insert for profile creation

**Availability Table:**
- ✓ availability_mentor_all: Mentors CRUD their own availability
- ✓ availability_select_all: Public read (needed for slot browsing per FR29)

**Time Slots Table:**
- ✓ time_slots_select_all: Public read (write controlled via application logic)
- ⚠️ No write policies (slots generated by application - intentional)

**Bookings Table:**
- ✓ bookings_select_own: Users view bookings where they participate
- ✓ bookings_insert_mentee: Mentees create bookings for themselves
- ✓ bookings_update_own: Participants can update their bookings

**Security Notes:**
- Coordinator override policies deferred to Epic 1 (documented in comments)
- No public write access on time_slots (application-managed) - correct design
- Public read policies align with discovery requirements (FR15, FR29)

**Compliance with NFR12:** ✓ RLS enforces role-based permissions

### Performance Considerations

**Index Strategy: Well-Designed**

13 indexes created (11 explicit + 2 from unique constraints):

**Query Pattern Optimization:**
- ✓ `idx_users_email` - Auth lookups (fast login checks)
- ✓ `idx_users_airtable_record_id` - Sync operations (webhook upserts)
- ✓ `idx_time_slots_mentor_start` - **Composite index** for slot browsing queries ("show mentor X's slots after date Y")
- ✓ `idx_time_slots_is_booked` - Available slot filtering
- ✓ `idx_bookings_mentee_id` / `idx_bookings_mentor_id` - User booking queries

**Performance Analysis:**
- Composite index on (mentor_id, start_time) enables efficient range queries
- Separate indexes on is_booked and mentor_id enable independent filtering
- Unique index on bookings.time_slot_id enforces business rule + improves lookups

**Estimated Performance (500 mentors, 30-day window):**
- ~60,000 time_slots rows (500 mentors × 4 blocks × 30 slots)
- Indexed queries: O(log n) lookup + O(k) result scan
- Expected query time: <50ms for typical slot browsing (well within NFR3: <1 second)

**Recommendations:**
- Monitor query performance when data grows beyond 5,000 users (NFR6)
- Consider partitioning time_slots by date range if performance degrades (post-MVP)

### Architecture Alignment

**Data Model Consistency:**

Verified against `docs/architecture/4-data-models.md`:

**Differences (Intentional for Epic 0):**
- ✓ Availability table simplified: No `recurrence_pattern`, `buffer_minutes`, `meeting_type` fields (added in Epic 4)
- ✓ User table missing: `reputation_score`, `reputation_tier`, `is_active`, `last_activity_at` (added in Epic 1)
- ✓ User Profiles missing: `linkedin_url`, `website_url`, `expertise_description`, etc. (added in Epic 2)
- ✓ Bookings missing: `materials_urls`, `google_meet_link`, `cancellation_reason` (added Epics 3-4)
- ✓ No soft delete columns: `deleted_at` (added in Epic 1)

All simplifications documented in migration comments with Epic references.

**Schema Evolution Path Clear:**
Migration comments explicitly document which fields are added in which Epic, creating clear roadmap for incremental development.

### Files Modified During Review

None - no code changes made during review. Identified issue (missing FK constraint on time_slots.booking_id) documented below for developer to address.

### Improvements Checklist

**Data Integrity:**
- [x] ✅ **COMPLETED:** Added foreign key constraint on `time_slots.booking_id` referencing `bookings(id) ON DELETE SET NULL`
  - **Implementation:** Lines 184-188 in migration file
  - **Result:** Data integrity fully enforced, prevents orphaned booking_id values
  - **Verified:** FK constraint active and documented

**Database Validation Enhancements:**
- [x] ✅ **COMPLETED:** Added CHECK constraints for time/date validation
  - `availability.chk_availability_time_range` (end_time > start_time)
  - `availability.chk_availability_date_range` (end_date >= start_date OR NULL)
  - `time_slots.chk_time_slots_time_range` (end_time > start_time)
  - `bookings.chk_bookings_meeting_time_range` (meeting_end_time > meeting_start_time)
  - **Result:** Database-level validation prevents invalid time ranges

**Testing (Deferred to Epic 1 - As Planned):**
- [ ] Add automated RLS policy tests when API endpoints built
- [ ] Add integration tests for concurrent booking scenarios
- [ ] Add constraint violation tests in API test suite
- [ ] Test CHECK constraint enforcement via invalid data insertion attempts

### Gate Status

**Gate:** ✅ PASS → docs/qa/gates/1.1-minimal-database-schema.yml

**Initial Status (2025-10-03):** CONCERNS - Missing FK constraint and optional CHECK constraints
**Updated Status (2025-10-03):** PASS - All issues resolved, schema production-ready

**Resolution Summary:**
- All data integrity concerns addressed (FK constraint added)
- Optional enhancements implemented (CHECK constraints added)
- Comprehensive documentation with QA issue references
- Schema exceeds Epic 0 requirements with robust validation layer

### Recommended Status

**Status Decision:** ✅ **APPROVED - Ready for Done**

**Rationale:**
- All 5 acceptance criteria fully met ✅
- All QA concerns resolved (DATA-001, VALID-001) ✅
- Schema quality excellent with comprehensive documentation ✅
- RLS policies appropriate for Epic 0 scope ✅
- Index strategy well-designed for expected query patterns ✅
- FK constraints complete (8 total) ensuring full referential integrity ✅
- CHECK constraints provide robust database-level validation ✅
- Manual testing approach appropriate for Walking Skeleton ✅

**No Further Actions Required** - Story is production-ready and exceeds Epic 0 requirements.

---

**Quality Score:** 95/100
- Initial: 85/100 (concerns identified)
- Updated: 95/100 (all concerns resolved)
- Remaining deduction: -5 for no automated tests (acceptable for Epic 0, tests deferred to API story as planned)

**Initial Review:** 2025-10-03  
**Follow-up Review (Post-Fixes):** 2025-10-03  
**Final Approval:** Quinn (Test Architect)

