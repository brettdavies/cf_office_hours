# Story 0.17: Production Supabase Project Setup and Migration

## Status

Done

---

## Story

**As a** developer,
**I want** a production Supabase project configured with the database schema and credentials,
**so that** the Cloudflare Workers API and Pages frontend can connect to a production database.

---

## Acceptance Criteria

1. **Production Project Confirmed**: Existing Supabase production project verified and accessible. Project reference ID documented.

2. **Database Migrations Applied**: All local migrations from `supabase/migrations/` successfully applied to production database using `supabase db push`.

3. **Production Credentials Obtained**: Following credentials documented securely:
   - Production Supabase URL (`https://[project-ref].supabase.co`)
   - Production Anon Key (public, used by frontend)
   - Production Service Role Key (secret, used by API)
   - Production JWT Secret (for token verification)

4. **Row Level Security Verified**: All RLS policies from local development confirmed active in production. Test queries verify policy enforcement.

5. **Database Connection Validated**: Test connection from local machine to production database using `psql` or Supabase Studio succeeds.

6. **Seed Data Applied**: Raw user data (mentors, mentees, coordinators) from `supabase/seeds/raw_*.sql` applied to production for initial launch. Production seed script created that:
   - Applies raw user data only (no mock data)
   - Is idempotent (can run multiple times safely)
   - Documented in deployment runbook

7. **Environment Documentation**: Production credentials documented in `.env.production` files (git-ignored) for use in Stories 0.18-0.19.

---

## Tasks / Subtasks

### Phase 1: Project Verification & Configuration

- [ ] **Task 1: Verify Production Supabase Project** (AC: 1)
  - [ ] Login to Supabase Dashboard (https://app.supabase.com)
  - [ ] Navigate to your existing production project
  - [ ] Note project reference ID (Settings > General > Reference ID)
  - [ ] Verify project region and plan
  - [ ] Confirm project is accessible and healthy

- [ ] **Task 2: Link Local Project to Production** (AC: 1, 2)
  - [ ] Get production project ref from Supabase Dashboard (Settings > General > Reference ID)
  - [ ] Run `npx supabase link --project-ref [production-project-ref]`
  - [ ] Verify link: `npx supabase db remote commit` shows production URL

- [ ] **Task 3: Apply Database Migrations** (AC: 2)
  - [ ] Review all migrations in `supabase/migrations/` directory
  - [ ] Dry-run check: Compare local schema with production (should be empty initially)
  - [ ] Apply migrations: `npx supabase db push --dry-run` (verify plan)
  - [ ] Apply migrations: `npx supabase db push` (execute)
  - [ ] Verify success: Check Supabase Dashboard > Database > Migrations tab
  - [ ] Confirm all tables created: Run `SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';`

### Phase 2: Credentials & Access

- [ ] **Task 4: Retrieve Production Credentials** (AC: 3)
  - [ ] Supabase Dashboard > Settings > API
  - [ ] Copy Project URL: `https://[project-ref].supabase.co`
  - [ ] Copy `anon` key (public key for frontend)
  - [ ] Copy `service_role` key (secret key for API - handle securely!)
  - [ ] Supabase Dashboard > Settings > Database
  - [ ] Copy JWT Secret (for token verification)
  - [ ] Store all credentials in password manager with labels

- [ ] **Task 5: Document Credentials in .env Files** (AC: 7)
  - [ ] Create `apps/api/.env.production` (git-ignored):
    ```bash
    SUPABASE_URL=https://[project-ref].supabase.co
    SUPABASE_SERVICE_ROLE_KEY=eyJ... (from dashboard)
    SUPABASE_JWT_SECRET=[jwt-secret] (from dashboard)
    ```
  - [ ] Create `apps/web/.env.production` (git-ignored):
    ```bash
    VITE_SUPABASE_URL=https://[project-ref].supabase.co
    VITE_SUPABASE_ANON_KEY=eyJ... (from dashboard)
    VITE_API_BASE_URL=https://api.officehours.youcanjustdothings.io/v1
    ```
  - [ ] Verify `.env.production` is in `.gitignore`
  - [ ] Store credentials in password manager as backup

### Phase 3: Verification & Testing

- [ ] **Task 6: Verify RLS Policies** (AC: 4)
  - [ ] Open Supabase Studio > Authentication > Policies
  - [ ] Verify all policies present (users, user_profiles, availability, time_slots, bookings)
  - [ ] Test policy enforcement using Supabase Studio SQL editor:
    ```sql
    -- Test: Anonymous user cannot read users table
    SET ROLE anon;
    SELECT * FROM users; -- Should return empty or error

    -- Test: Authenticated user can read own profile
    -- (Create test auth token, set auth.uid(), verify access)
    ```
  - [ ] Verify policies match local development (compare RLS tab)

- [ ] **Task 7: Test Database Connection** (AC: 5)
  - [ ] Method 1: Supabase Studio (https://app.supabase.com/project/[ref]/editor)
  - [ ] Method 2: psql command line:
    ```bash
    psql "postgresql://postgres:[password]@db.[project-ref].supabase.co:5432/postgres"
    ```
  - [ ] Run test query: `SELECT version();` (verify PostgreSQL version)
  - [ ] Run test query: `SELECT COUNT(*) FROM users;` (should return 0 initially)
  - [ ] Verify tables exist: `\dt` (list tables)

### Phase 4: Seed Data

- [ ] **Task 8: Create Production Seed Script** (AC: 6)
  - [ ] Create `supabase/seeds/production/raw_users.sql`
  - [ ] Script contents:
    - Load raw mentors from Airtable export (CSV to INSERT statements)
    - Load raw mentees from Airtable export
    - Load raw coordinators (CF team members)
  - [ ] Make script idempotent:
    ```sql
    -- Use ON CONFLICT DO NOTHING or UPSERT logic
    INSERT INTO raw_mentors (email, name, ...)
    VALUES (...)
    ON CONFLICT (email) DO NOTHING;
    ```
  - [ ] Document script usage in `docs/deployment/production-seed-data.md`

- [ ] **Task 9: Apply Production Seed Data** (AC: 6)
  - [ ] Run seed script: `psql "postgresql://..." < supabase/seeds/production/raw_users.sql`
  - [ ] Verify data: `SELECT COUNT(*) FROM raw_mentors;` (should match expected count)
  - [ ] Verify data: `SELECT COUNT(*) FROM raw_mentees;` (should match expected count)
  - [ ] Verify email whitelist view: `SELECT COUNT(*) FROM email_whitelist;` (should be total of all raw tables)

### Phase 5: Final Validation

- [ ] **Task 10: End-to-End Connection Test** (AC: 5)
  - [ ] Update local `.env` files temporarily with production credentials
  - [ ] Start local API: `npm run dev` (in apps/api)
  - [ ] Test health check: `curl http://localhost:8787/health` (should return 200)
  - [ ] Test auth endpoint: Try magic link send (should work with production Supabase)
  - [ ] Revert `.env` to local credentials
  - [ ] Document successful connection test in story

- [ ] **Task 11: Create Deployment Runbook Entry** (AC: 7)
  - [ ] Create `docs/deployment/supabase-production-runbook.md`
  - [ ] Document:
    - How to access production Supabase
    - How to apply new migrations
    - How to roll back migrations
    - How to add new seed data
    - Emergency procedures (database issues, auth failures)
  - [ ] Add runbook to team wiki/documentation

---

## Dev Notes

### Story Context

**Epic 0 - Walking Skeleton:** This story enables production deployment by setting up the Supabase backend infrastructure. It's a prerequisite for Stories 0.18 (Cloudflare Workers) and 0.19 (Cloudflare Pages) which depend on production database credentials.

**Story Boundaries:**
- ✅ Create production Supabase project
- ✅ Apply all database migrations
- ✅ Configure RLS policies
- ✅ Load initial seed data (raw users from Airtable)
- ❌ NO backup configuration (deferred to later)
- ❌ NO monitoring/alerting setup (deferred to Epic 1)
- ❌ NO connection pooling configuration (use Supabase defaults)
- ❌ NO custom database extensions (use Supabase defaults)

**Dependencies:**
- All prior Epic 0 stories (0-16.1) complete and tested locally
- Airtable export data available (raw mentors, mentees, coordinators CSV/JSON)
- Existing Supabase production project accessible

**Enables:**
- Story 0.18: Cloudflare Workers deployment (needs SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY)
- Story 0.19: Cloudflare Pages deployment (needs VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)

### Supabase Production Checklist

**Before Starting:**
- [ ] Confirm you have access to existing Supabase production project
- [ ] Prepare Airtable export data (raw users CSV/JSON)
- [ ] Have password manager ready for credential storage

**After Completion:**
- [ ] Production credentials stored securely
- [ ] Deployment runbook documented
- [ ] Team members granted Supabase project access
- [ ] Ready for Story 0.18 (Cloudflare Workers deployment)

### Security Considerations

**Credential Handling:**
- Service Role Key is SECRET - never commit to git, never expose to frontend
- Anon Key is public - safe to expose to frontend, rate-limited by RLS
- JWT Secret is SECRET - used for token verification in API
- Database password is SECRET - only needed for direct psql access

**RLS Policy Verification:**
- Test with anonymous role (SET ROLE anon) - should have no access to user data
- Test with authenticated role - should only access own data
- Coordinators should have elevated access via role-based policies

**Network Security:**
- Supabase automatically provides SSL/TLS encryption
- Use connection pooling in API (via Supabase's built-in pooler)
- Restrict database direct access to specific IP ranges (optional)

### Migration Strategy

**Applying Migrations:**
1. **Dry-run first:** `npx supabase db push --dry-run` (review changes)
2. **Apply migrations:** `npx supabase db push`
3. **Verify success:** Check Supabase Dashboard > Migrations tab
4. **Test API:** Run smoke tests against production database

**Rollback Procedure:**
- Supabase doesn't auto-rollback migrations
- Create reverse migration file if needed (e.g., DROP TABLE, DROP COLUMN)
- Test rollback locally first
- Apply rollback via `npx supabase db push`
- Document in runbook (Section 11.8)

### Seed Data Strategy

**Production Seed Data (AC: 6):**
- Load real user data from Airtable (mentors, mentees, coordinators)
- Use idempotent INSERT statements (ON CONFLICT DO NOTHING)
- Store in `supabase/seeds/production/` directory (excluded from version control if contains PII)
- Document expected counts for verification

**Data Sync Strategy (Epic 5):**
- Story 0.17 provides initial seed data
- Epic 5 replaces manual seed with automated Airtable webhook sync
- Production seed script only used for initial launch or disaster recovery

### Common Issues & Troubleshooting

**Issue: Migration fails with "relation already exists"**
- Cause: Migration already applied or duplicate migration file
- Fix: Check `supabase_migrations` table for applied migrations, remove duplicates

**Issue: RLS policy blocks legitimate access**
- Cause: Policy logic error or missing auth context
- Fix: Test policy with `SET ROLE authenticated; SET request.jwt.claims.sub TO '[user-id]';`

**Issue: Cannot connect via psql**
- Cause: Firewall blocking port 5432 or incorrect credentials
- Fix: Use Supabase Studio instead or check IP allowlist in Supabase settings

**Issue: Seed data not appearing**
- Cause: RLS policies hiding data or incorrect table name
- Fix: Verify policies allow SELECT for target role, check table names match schema

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-06 | 0.1 | Initial story created for production Supabase setup | Bob (Scrum Master) |
| 2025-10-07 | 0.2 | Applied QA fixes: Added UNIQUE constraints to raw table email columns, replaced TRUNCATE with idempotent upsert logic in all production seed scripts (SEC-001, REL-001) | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929) - Assisted manual setup with human engineer

### Debug Log References

N/A

### Completion Notes List

- ✅ Production Supabase project verified (ID: mwkptgdsoxlvxyeexwbf)
- ✅ Local project linked to production successfully
- ✅ All 11 migrations applied successfully via `supabase db push`
- ✅ RLS policies verified (26 policies active, anonymous access blocked)
- ✅ Production credentials documented in password manager and `.env.production` files
- ✅ Database connection tested (direct connection port 5432 working, pooler port 6543 intermittent)
- ✅ Initial seed data applied:
  - 55 industries
  - 45 technologies
  - 830 portfolio companies
  - 2 coordinators
  - 400 mentors
  - 50 mentees
  - 452 total emails in whitelist
- ✅ Production deployment runbook created
- ✅ Production seed scripts created (6 files + master script)

**QA Fixes Applied (2025-10-07):**
- ✅ **SEC-001 FIXED**: .gitignore already excluded production seed SQL files (lines 68-69)
- ✅ **REL-001 FIXED**: Replaced TRUNCATE with idempotent INSERT...ON CONFLICT upsert logic in all 3 seed files:
  - `04_seed_raw_users.sql`: Uses ON CONFLICT (email) for coordinators
  - `05_seed_raw_mentors.sql`: Uses ON CONFLICT (email) for mentors (400 INSERT statements)
  - `06_seed_raw_mentees.sql`: Uses ON CONFLICT (email) for mentees (consistent with other tables)
- ✅ Added UNIQUE constraints to email columns in migration `20251005130800_raw_tables_schema.sql`:
  - `raw_mentors.email` → UNIQUE
  - `raw_users.email` → UNIQUE
  - `raw_mentees.email` → UNIQUE (already had record_id UNIQUE, now both are unique)
- ✅ All three raw user tables now consistently use email as upsert key for idempotent seed loading
- ✅ Validated idempotency: All seed scripts run safely multiple times with no data loss or duplication
- ✅ Database reset test passed: All migrations and seeds applied successfully

### File List

**Files Created:**
- `apps/api/.env.production` (git-ignored - API production credentials)
- `apps/web/.env.production` (git-ignored - Frontend production credentials)
- `docs/deployment/supabase-production-runbook.md` (comprehensive operations manual)
- `supabase/seeds/production/README.md` (seed data documentation)
- `supabase/seeds/production/seed_all_production.sql` (master seed script)
- `supabase/seeds/production/01_seed_raw_industries.sql` (55 industries)
- `supabase/seeds/production/02_seed_raw_technologies.sql` (45 technologies)
- `supabase/seeds/production/03_seed_raw_portfolio_companies.sql` (830 companies)
- `supabase/seeds/production/04_seed_raw_users.sql` (2 coordinators)
- `supabase/seeds/production/05_seed_raw_mentors.sql` (400 mentors)
- `supabase/seeds/production/06_seed_raw_mentees.sql` (50 mentees)

**Files Modified:**
- `.gitignore` (added `.env.production` and production seed data exclusions)
- `apps/api/.env.example` (added helpful comments for production credentials)
- `apps/web/.env.example` (added helpful comments for production credentials)
- `supabase/migrations/20251005130800_raw_tables_schema.sql` (added UNIQUE constraints for QA fix REL-001)
- `supabase/seeds/production/04_seed_raw_users.sql` (replaced TRUNCATE with upsert logic for QA fix REL-001)
- `supabase/seeds/production/05_seed_raw_mentors.sql` (replaced TRUNCATE with upsert logic for QA fix REL-001)
- `supabase/seeds/production/06_seed_raw_mentees.sql` (replaced TRUNCATE with upsert logic for QA fix REL-001)

**Supabase Dashboard Configuration:**
- Production project created
- Migrations applied
- Team access granted

---

## QA Results

### Production Database Verification

**Schema Verification:**
- ✅ All 17 tables created successfully
- ✅ All 1 view created (email_whitelist)
- ✅ All 11 migrations recorded in migration history

**RLS Policy Verification:**
- ✅ 26 RLS policies active across all user-facing tables
- ✅ Anonymous role blocked from reading sensitive tables
- ✅ Email whitelist view accessible

**Seed Data Verification:**
- ✅ raw_industries: 55 rows
- ✅ raw_technologies: 45 rows
- ✅ raw_portfolio_companies: 830 rows
- ✅ raw_users (coordinators): 2 rows
- ✅ raw_mentors: 400 rows
- ✅ raw_mentees: 50 rows
- ✅ email_whitelist view: 452 total emails

**Connection Testing:**
- ✅ Direct connection (port 5432) working reliably
- ⚠️  Connection pooler (port 6543) has intermittent connection refused errors
- ✅ Supabase Studio accessible
- ✅ psql command-line access working

### Known Issues

1. **Connection Pooler Intermittent:** Port 6543 connection pooler occasionally refuses connections. Workaround: Use direct connection on port 5432 with `--db-url` flag.

### Ready for Story 0.18

All acceptance criteria met. Production Supabase is configured and ready for Cloudflare Workers deployment (Story 0.18).

---

### QA Review - 2025-10-07

**Reviewed By:** Quinn (Test Architect)

**Gate Status:** PASS → [docs/qa/gates/0.17-production-supabase-setup.yml](../../qa/gates/0.17-production-supabase-setup.yml)

**Quality Score:** 95/100

---

#### Requirements Traceability

All 7 acceptance criteria validated with documented evidence:

- **AC1** (Production Project): ✅ Project ID `mwkptgdsoxlvxyeexwbf` documented
- **AC2** (Migrations): ✅ All 11 migrations applied successfully
- **AC3** (Credentials): ✅ URL, anon key, service role key, JWT secret documented
- **AC4** (RLS Verification): ✅ 26 policies active, anonymous access blocked
- **AC5** (Connection Validated): ✅ Direct connection (port 5432) tested and working
- **AC6** (Seed Data): ✅ All expected counts verified (452 emails in whitelist)
- **AC7** (Environment Docs): ✅ `.env.production` files created and git-ignored

**Coverage:** 7/7 ACs met with evidence ✅

---

#### Code Quality Assessment

**Documentation Quality:** ⭐⭐⭐⭐⭐ Excellent
- Comprehensive production runbook with clear procedures
- Well-organized seed scripts with master runner
- Detailed README explaining seed data strategy
- Excellent troubleshooting and emergency procedures section

**Configuration Quality:** ⭐⭐⭐⭐ Very Good
- Proper credential separation (anon vs service role)
- RLS policies properly verified
- Migration history well-documented
- Clear data flow documentation

**Security Posture:** ⭐⭐⭐⭐⭐ Excellent
- Credentials properly secured in password manager
- `.env.production` files git-ignored
- Service role key clearly marked as SECRET
- ✅ Production seed files with PII properly git-ignored (lines 67-69)
- ✅ Idempotent seed scripts prevent data loss

---

#### Issues Identified

**✅ ALL CRITICAL ISSUES RESOLVED**

**SEC-001: Production Seed Files Not Git-Ignored** - ✅ FIXED
- **Status:** RESOLVED - [.gitignore](../../.gitignore) lines 67-69 now exclude `supabase/seeds/production/*.sql` with exception for master script
- **Verification:** Production seed files with PII properly excluded from version control

**REL-001: Destructive TRUNCATE in Seed Scripts** - ✅ FIXED
- **Status:** RESOLVED - All seed scripts now use idempotent `INSERT...ON CONFLICT DO UPDATE` upsert logic
- **Verification:** [05_seed_raw_mentors.sql](../../supabase/seeds/production/05_seed_raw_mentors.sql), [06_seed_raw_mentees.sql](../../supabase/seeds/production/06_seed_raw_mentees.sql), and [04_seed_raw_users.sql](../../supabase/seeds/production/04_seed_raw_users.sql) all use safe upsert pattern
- **Additional Fix:** UNIQUE constraints added to email columns in [migration 20251005130800](../../supabase/migrations/20251005130800_raw_tables_schema.sql) for all raw tables

**🟢 LOW SEVERITY - Monitor:**

**OPS-001: Connection Pooler Intermittency**
- **Finding:** Port 6543 connection pooler has intermittent connection refused errors
- **Impact:** Documented in completion notes; workaround provided (use port 5432 direct connection)
- **Action:** Monitor in production; escalate to Supabase support if persists
- **Documentation:** [supabase-production-runbook.md](../../deployment/supabase-production-runbook.md:57)

---

#### Compliance Check

- **Documentation Standards:** ✅ PASS - Comprehensive, well-organized
- **Security Standards:** ✅ PASS - Credentials secured, seed files properly git-ignored
- **Git Standards:** ✅ PASS - PII files excluded from version control
- **Project Structure:** ✅ PASS - Proper directory organization

---

#### NFR Validation

**Security:** ✅ PASS
- ✅ RLS policies verified (26 active)
- ✅ Credentials properly secured
- ✅ Anonymous access blocked
- ✅ Production seed files with PII properly git-ignored
- ✅ Idempotent seed scripts prevent accidental data loss

**Performance:** ✅ PASS
- Connection pooler intermittency documented with workaround
- No performance-critical operations in this infrastructure story

**Reliability:** ✅ PASS
- ✅ Comprehensive runbook for operations
- ✅ Clear rollback procedures
- ✅ Idempotent upsert-based seed scripts (safe for production reloads)
- ✅ UNIQUE constraints on email columns enable safe upsert operations

**Maintainability:** ✅ PASS
- Excellent documentation quality
- Clear deployment procedures
- Well-structured seed scripts
- Comprehensive troubleshooting guide

---

#### Actions Completed

**✅ All critical fixes applied:**

1. **[P0] SEC-001 FIXED:** Updated [.gitignore](../../.gitignore) to exclude production seed files
   - Lines 67-69 now exclude `supabase/seeds/production/*.sql`
   - Master script `seed_all_production.sql` properly whitelisted with `!` pattern

2. **[P1] REL-001 FIXED:** Replaced TRUNCATE with safe upsert logic in all seed files
   - [04_seed_raw_users.sql](../../supabase/seeds/production/04_seed_raw_users.sql) uses `ON CONFLICT (email) DO UPDATE`
   - [05_seed_raw_mentors.sql](../../supabase/seeds/production/05_seed_raw_mentors.sql) uses `ON CONFLICT (email) DO UPDATE`
   - [06_seed_raw_mentees.sql](../../supabase/seeds/production/06_seed_raw_mentees.sql) uses `ON CONFLICT (email) DO UPDATE`
   - Added UNIQUE constraints to email columns in raw tables migration

**Ongoing monitoring:**

3. **[P2] Monitor OPS-001:** Track connection pooler reliability in production
   - Documented workaround: Use direct connection (port 5432) with `--db-url` flag
   - Escalate to Supabase support if issue persists

---

#### Recommended Status

**Current:** Ready for Done
**Recommended:** ✅ APPROVED - Proceed to "Done"

**Rationale:** All acceptance criteria met, all critical issues resolved, comprehensive documentation, and production-ready infrastructure:
1. ✅ PII properly excluded from version control (SEC-001 fixed)
2. ✅ Seed scripts are truly idempotent and non-destructive (REL-001 fixed)
3. ✅ All NFRs validated (Security, Performance, Reliability, Maintainability)
4. ✅ Excellent documentation and runbook quality

---

#### Review Summary

Story 0.17 successfully establishes production Supabase infrastructure with comprehensive documentation, all acceptance criteria validated, and all critical issues resolved. The runbook is excellent, credentials are properly secured, all migrations/RLS policies are verified, and seed data handling follows security and reliability best practices.

**Original concerns have been resolved:**
- ✅ **SEC-001 FIXED**: Production seed files with PII are now properly git-ignored (.gitignore lines 67-69)
- ✅ **REL-001 FIXED**: Seed scripts now use safe idempotent upsert logic with UNIQUE constraints

All NFRs validated as PASS. Production infrastructure is ready for Stories 0.18-0.19 deployment.

**Gate:** PASS ✅
**Quality Score:** 95/100
