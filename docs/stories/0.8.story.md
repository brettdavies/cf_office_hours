# Story 0.8: SKEL-AVAIL-001

## Status
Draft

## Story
**As a** mentor,
**I want** to create and manage my availability blocks through a simple API,
**so that** I can define when I'm available for mentee meetings without complex scheduling logic.

## Acceptance Criteria
1. **Availability Block Creation**: POST /v1/availability endpoint creates a simple availability block (one-time only, no recurrence in this story)
2. **Field Validation**: Validates all required fields (start_time, end_time, slot_duration_minutes, meeting_type) using Zod schemas
3. **Meeting Type Support**: Supports "online" meeting type only (in-person types deferred to later stories)
4. **Authentication Required**: Endpoint requires valid JWT authentication (mentor role)
5. **Response Format**: Returns created availability block with generated ID and timestamps
6. **Error Handling**: Returns appropriate error codes (400 for validation, 401 for auth, 403 for non-mentors)
7. **Database Persistence**: Stores availability block in `availability_blocks` table with audit fields
8. **OpenAPI Documentation**: Endpoint is documented in OpenAPI spec with request/response schemas

## Tasks / Subtasks

### 1. Create Zod Schemas for Availability (AC: 2)
- [ ] Create `packages/shared/src/schemas/availability.ts`
  - [ ] Define `CreateAvailabilityBlockSchema` with fields:
    - `start_time` (ISO datetime string, required)
    - `end_time` (ISO datetime string, required)
    - `slot_duration_minutes` (enum: 15, 20, 30, 60, required)
    - `buffer_minutes` (number, default: 0, optional)
    - `meeting_type` (enum: "online" only for now, required)
    - `description` (string, optional)
  - [ ] Define `AvailabilityBlockResponseSchema` with all DB fields
  - [ ] Export TypeScript types using `z.infer<typeof Schema>`
  - [ ] Add validation rules:
    - `end_time` must be after `start_time`
    - `buffer_minutes` must be 0-60
    - `slot_duration_minutes` must be one of: 15, 20, 30, 60

### 2. Create Availability Repository (AC: 7)
- [ ] Create `apps/api/src/repositories/availability.repository.ts`
  - [ ] Extend `BaseRepository` class
  - [ ] Implement `create(mentorId, data)` method
    - Insert into `availability_blocks` table
    - Set `created_by`, `updated_by` to mentorId
    - Set `created_at`, `updated_at` to NOW()
    - Set `recurrence_pattern` to 'one_time'
    - Return created record with all fields
  - [ ] Implement `findByMentor(mentorId)` method for future use
  - [ ] Implement `findById(id)` method for future use

### 3. Create Availability Service (AC: 1, 3, 4)
- [ ] Create `apps/api/src/services/availability.service.ts`
  - [ ] Inject `AvailabilityRepository` in constructor
  - [ ] Implement `createAvailabilityBlock(mentorId, data)` method:
    - Validate user is a mentor (throw 403 if not)
    - Validate meeting_type is "online" only (throw 400 if not)
    - Call repository to create block
    - Return formatted response
  - [ ] Add proper error handling with custom error codes

### 4. Create Availability Route with OpenAPI (AC: 1, 5, 6, 8)
- [ ] Create `apps/api/src/routes/availability.ts`
  - [ ] Define POST `/` route using `@hono/zod-openapi`
  - [ ] Add OpenAPI route definition with:
    - Request body: `CreateAvailabilityBlockSchema`
    - Response 201: `AvailabilityBlockResponseSchema`
    - Response 400: Validation error format
    - Response 401: Unauthorized
    - Response 403: Forbidden (non-mentor)
    - Tags: ["Availability"]
    - Summary: "Create availability block (one-time only)"
  - [ ] Implement route handler:
    - Apply `authMiddleware`
    - Apply `rbacMiddleware(['mentor'])`
    - Get user from context
    - Call `AvailabilityService.createAvailabilityBlock()`
    - Return 201 with created block
  - [ ] Export `availabilityRoutes` router

### 5. Mount Availability Routes (AC: 1)
- [ ] Update `apps/api/src/routes/index.ts`
  - [ ] Import `availabilityRoutes`
  - [ ] Mount at `/availability` path

### 6. Write Unit Tests (AC: All)
- [ ] Create `apps/api/src/repositories/availability.repository.test.ts`
  - [ ] Test `create()` with valid data
  - [ ] Test `create()` with missing required fields
  - [ ] Test `findByMentor()` returns mentor's blocks only
- [ ] Create `apps/api/src/services/availability.service.test.ts`
  - [ ] Test successful block creation as mentor
  - [ ] Test rejection when non-mentor attempts creation
  - [ ] Test validation of meeting_type (must be "online")
  - [ ] Test end_time > start_time validation
- [ ] Create `apps/api/src/routes/availability.test.ts`
  - [ ] Test POST /availability with valid JWT (mentor role) returns 201
  - [ ] Test POST /availability without JWT returns 401
  - [ ] Test POST /availability as mentee returns 403
  - [ ] Test POST /availability with invalid data returns 400
  - [ ] Test POST /availability with in-person meeting type returns 400

### 7. Update OpenAPI Documentation (AC: 8)
- [ ] Verify OpenAPI spec generation at `/api/openapi.json`
  - [ ] Confirm POST /v1/availability is present
  - [ ] Confirm request/response schemas are correct
  - [ ] Confirm security requirement (bearerAuth) is present
- [ ] Test Swagger UI at `/api/docs` renders availability endpoint

## Dev Notes

### Architecture Context
This is the first availability management story in Epic 0 (Foundation Infrastructure). This story intentionally implements ONLY simple one-time availability blocks. Recurrence patterns (weekly, monthly), time slot generation, and calendar conflict checking are deferred to later stories.

**Key Architectural Decisions:**
- **Simple First**: Only one-time availability blocks in this story (no recurrence logic)
- **Online Only**: Only "online" meeting type supported (in-person deferred)
- **No Slot Generation**: Time slots are NOT generated in this story (deferred to story 0.10)
- **Mentor-Only**: Only mentors can create availability blocks (enforced via RBAC)
- **Audit Trail**: All blocks have created_by/updated_by/created_at/updated_at fields

### Source Tree
```
packages/shared/src/schemas/
  └── availability.ts (NEW - Zod schemas for availability)

apps/api/src/
  ├── repositories/
  │   └── availability.repository.ts (NEW)
  ├── services/
  │   └── availability.service.ts (NEW)
  └── routes/
      ├── availability.ts (NEW)
      └── index.ts (MODIFIED - mount availability routes)
```

### Database Schema Reference
From `docs/architecture/database-schema.md`:

**Table**: `availability_blocks`
```sql
CREATE TABLE availability_blocks (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mentor_id UUID NOT NULL REFERENCES users(id),
  recurrence_pattern recurrence_pattern_enum NOT NULL, -- Use 'one_time' for this story
  start_date DATE, -- NULL for one-time (stored in start_time)
  end_date DATE, -- NULL for one-time
  start_time TIMESTAMPTZ NOT NULL, -- Full datetime for one-time blocks
  end_time TIMESTAMPTZ NOT NULL,
  slot_duration_minutes INTEGER NOT NULL CHECK (slot_duration_minutes IN (15, 20, 30, 60)),
  buffer_minutes INTEGER DEFAULT 0 CHECK (buffer_minutes >= 0 AND buffer_minutes <= 60),
  meeting_type meeting_type_enum NOT NULL, -- 'online' only for this story
  location_preset_id UUID REFERENCES locations(id), -- NULL for online
  location_custom TEXT, -- NULL for online
  description TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  created_by UUID REFERENCES users(id),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  updated_by UUID REFERENCES users(id),
  deleted_at TIMESTAMPTZ,
  deleted_by UUID REFERENCES users(id),
  CONSTRAINT valid_time_range CHECK (end_time > start_time)
);
```

**Important Field Notes:**
- `recurrence_pattern`: Set to 'one_time' for all blocks in this story
- `start_time`/`end_time`: Store full UTC datetimes (TIMESTAMPTZ)
- `start_date`/`end_date`: Leave NULL for one-time blocks
- `meeting_type`: Only accept 'online' in validation
- `location_preset_id`/`location_custom`: Leave NULL (online meetings)

### API Contract Reference
From `docs/architecture/5-api-specification.md`:

**Endpoint**: POST /v1/availability
**Request Body**:
```typescript
{
  start_time: string; // ISO 8601 datetime
  end_time: string; // ISO 8601 datetime
  slot_duration_minutes: 15 | 20 | 30 | 60;
  buffer_minutes?: number; // 0-60, default 0
  meeting_type: "online"; // Only "online" for this story
  description?: string;
}
```

**Response 201**:
```typescript
{
  id: string; // UUID
  mentor_id: string; // UUID
  recurrence_pattern: "one_time";
  start_time: string; // ISO 8601 datetime
  end_time: string; // ISO 8601 datetime
  slot_duration_minutes: number;
  buffer_minutes: number;
  meeting_type: "online";
  location_preset_id: null;
  location_custom: null;
  description: string | null;
  created_at: string; // ISO 8601 datetime
  updated_at: string; // ISO 8601 datetime
  created_by: string; // UUID
  updated_by: string; // UUID
}
```

### Error Handling
Use standard API error format from architecture:
```typescript
{
  error: {
    code: string; // e.g., "VALIDATION_ERROR", "FORBIDDEN"
    message: string;
    details?: Record<string, any>;
    timestamp: string;
    request_id: string;
  }
}
```

**Common Error Codes for This Story:**
- `VALIDATION_ERROR` (400): Invalid request data (Zod validation failure)
- `UNAUTHORIZED` (401): Missing or invalid JWT token
- `FORBIDDEN` (403): User is not a mentor
- `INVALID_MEETING_TYPE` (400): Meeting type is not "online"

### Type System Usage
Per Story 0.6.1 migration:
- **Backend**: Use `z.infer<typeof AvailabilityBlockSchema>` for types
- **Frontend**: Will use types from `api.generated.ts` (generated via `openapi-typescript`)
- **No Manual Interfaces**: Do NOT create manual TypeScript interfaces

### Integration Points
- **Supabase Database**: Direct writes to `availability_blocks` table
- **Authentication**: Uses existing `authMiddleware` from Story 0.4
- **RBAC**: Uses existing `rbacMiddleware(['mentor'])` pattern
- **OpenAPI**: Auto-generates spec via `@hono/zod-openapi`

### Testing

#### Test File Locations
```
apps/api/src/repositories/availability.repository.test.ts
apps/api/src/services/availability.service.test.ts
apps/api/src/routes/availability.test.ts
```

#### Testing Framework
- **Framework**: Vitest
- **Pattern**: Unit tests for each layer (repository, service, route)
- **Mocking**: Mock Supabase client in repository tests
- **Test Database**: Use test Supabase instance with seeded data

#### Test Standards (from Architecture)
1. **Repository Tests**:
   - Test successful CRUD operations
   - Test constraint violations (e.g., end_time <= start_time)
   - Test foreign key relationships
   - Mock Supabase client using `vi.mock()`

2. **Service Tests**:
   - Test business logic (mentor-only validation)
   - Test error conditions (non-mentor, invalid meeting type)
   - Mock repository layer
   - Use `beforeEach` to reset mocks

3. **Route Tests**:
   - Test HTTP status codes (201, 400, 401, 403)
   - Test request/response formats
   - Test middleware integration (auth, RBAC)
   - Use Hono's `app.request()` for testing

#### Required Test Coverage
- **Minimum**: 80% line coverage
- **Focus**: Edge cases and error paths
- **Run**: `npm run test:api` before committing

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-05 | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
_To be populated by dev agent_

### Debug Log References
_To be populated by dev agent_

### Completion Notes List
_To be populated by dev agent_

### File List
_To be populated by dev agent_

## QA Results
_To be populated by QA agent_
