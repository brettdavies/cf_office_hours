# Story 0.20: Enhanced Local Development Seed Data

## Status

Complete

---

## Story

**As a** developer,
**I want** realistic availability slots and booking data for comprehensive local testing,
**so that** I can develop and test features with production-like scenarios without deploying to production.

---

## Acceptance Criteria

1. **Availability Slots for All Mentors:**
   - Each mentor has 3 availability blocks across upcoming 3 weeks
   - Week 1: Random date NOW() + random {1-7} days, random time 8am-8pm, random duration (15min, 30min, 60min)
   - Week 2: Random date NOW() + random {8-14} days, random time 8am-8pm, random duration (15min, 30min, 60min)
   - Week 3: Random date NOW() + random {15-21} days, random time 8am-8pm, random duration (15min, 30min, 60min)
   - SQL seed file uses dynamic date calculation (e.g., `NOW() + INTERVAL '5 days' + INTERVAL '9 hours'`)
   - Each availability block generates time slots (per existing availability schema)

2. **Booking Slots for Mentees:**
   - 50% of available slots have bookings
   - Bookings split: 50% status='pending', 50% status='confirmed'
   - Random mentee assigned to each booking (from ALL mentees in seed data)
   - Random meeting_goal text (from predefined templates: "Discuss fundraising strategy", "Get feedback on product roadmap", etc.)

3. **Test Coverage:**
   - Test: Verify availability blocks created (1200 blocks = 400 mentors × 3 blocks)
   - Test: Verify time slots generated (1200 slots)
   - Test: Verify bookings created (approximately 50% of slots booked)
   - Test: Verify booking status distribution (approximately 50% pending, 50% confirmed)

4. **Production Seed Files Updated:**
   - All changes applied to `supabase/seeds/production/*.sql` to match local seed behavior
   - Production seeds use same dynamic date logic for realistic test data in production environment

---

## Tasks / Subtasks

### Phase 1: Fix User Seed Files for Local Development

- [x] **Task 1: Update mentee seed file to create users directly**
  - [x] Add user creation logic after raw_mentees insert
  - [x] Insert into users table from raw_mentees data (ALL 50 mentees)
  - [x] Use ON CONFLICT DO NOTHING for idempotency

- [x] **Task 2: Update coordinator seed file to create users directly**
  - [x] Add user creation logic after raw_users insert
  - [x] Insert into users table from raw_users data (2 coordinators)
  - [x] Use ON CONFLICT DO NOTHING for idempotency

- [x] **Task 3: Update mentor seed file to create users directly**
  - [x] Add user creation logic after raw_mentors insert
  - [x] Insert into users table from raw_mentors data (ALL 400 mentors)
  - [x] Use ON CONFLICT DO NOTHING for idempotency

### Phase 2: Create Availability Seed Data (AC: 1)

- [x] **Task 4: Create new seed file `supabase/seeds/07_seed_availability.sql`**
  - [x] Add file header with description and usage instructions
  - [x] Generate random time between 8am-8pm using PostgreSQL random()
  - [x] Generate random duration (15, 30, or 60 minutes) - adjusted to match schema constraints
  - [x] For EACH of ALL 400 mentors from `06_seed_mentors.sql`:
    - [x] Week 1: Generate 1 availability block with `NOW() + random(1-7) days + random(8-20) hours`
    - [x] Week 2: Generate 1 availability block with `NOW() + random(8-14) days + random(8-20) hours`
    - [x] Week 3: Generate 1 availability block with `NOW() + random(15-21) days + random(8-20) hours`
  - [x] Each availability block includes: `mentor_id`, `start_time` (timestamptz), `end_time` (start + duration), `slot_duration_minutes`, `location` (random from preset locations)
  - [x] Use DELETE approach for idempotency (safer than TRUNCATE)

- [x] **Task 5: Generate time slots from availability blocks**
  - [x] Implemented time slot generation logic in seed file
  - [x] For each availability block, generate slots based on `slot_duration_minutes`
  - [x] Each slot: `availability_id`, `mentor_id`, `start_time`, `end_time`, `is_booked=false` (default)
  - [x] Time slots generated inline (no temp table needed)

### Phase 3: Create Booking Seed Data (AC: 2)

- [x] **Task 6: Create separate seed file `supabase/seeds/08_seed_bookings.sql`**
  - [x] Query all time_slots, order by RANDOM(), limit to 50%
  - [x] For each selected slot:
    - [x] Select random mentee from ALL mentees in `04_seed_mentees.sql` (50 mentees)
    - [x] Select random meeting_goal from templates array:
      - "Discuss fundraising strategy"
      - "Get feedback on product roadmap"
      - "Review pitch deck"
      - "Explore partnership opportunities"
      - "Career mentorship session"
      - "Technical architecture review"
      - "Go-to-market strategy discussion"
  - [x] Create booking with: `time_slot_id`, `mentee_id`, `mentor_id`, `meeting_goal`, `location`, `meeting_start_time`, `meeting_end_time`, `status`
  - [x] Update `time_slots.is_booked = true` for booked slots
  - [x] Split status 50/50: Use `CASE WHEN random() < 0.5 THEN 'pending' ELSE 'confirmed' END`

### Phase 4: Update Production Seed Files (AC: 4)

- [x] **Task 7: Create `supabase/seeds/production/07_seed_raw_availability.sql`**
  - [x] Copy logic from local `07_seed_availability.sql`
  - [x] Use same dynamic date calculation (NOW() + intervals) for realistic test data
  - [x] Ensure idempotency (safe for re-runs with DELETE approach)

- [x] **Task 8: Create `supabase/seeds/production/08_seed_raw_bookings.sql`**
  - [x] Copy logic from local `08_seed_bookings.sql`
  - [x] Use same randomization logic for realistic test data
  - [x] Ensure idempotency (safe for re-runs with DELETE approach)

- [x] **Task 9: Update `supabase/seeds/production/seed_all_production.sql`**
  - [x] Add section for availability seed file
  - [x] Add section for bookings seed file
  - [x] Update verification queries to include availability and bookings counts
  - [x] Update "Next steps" documentation

### Phase 5: Testing (AC: 3)

- [x] **Task 10: Test local seed files**
  - [x] Reset local Supabase: `supabase db reset`
  - [x] Run availability seed: `psql -f 07_seed_availability.sql`
  - [x] Run bookings seed: `psql -f 08_seed_bookings.sql`
  - [x] Verify availability blocks count = 1200 (400 mentors × 3 blocks) ✓
  - [x] Verify time slots generated = 1200 ✓
  - [x] Verify bookings created = 600 (50% of slots) ✓
  - [x] Verify booking status distribution: ~50% pending (309), ~50% confirmed (291) ✓

---

## Dev Notes

### Story Context

This story enhances Story 0.2 (SKEL-DB-002: Mock Data Seeding Script) by adding realistic availability and booking data for local development. The original seed script created users, taxonomy, and portfolio companies, but lacked availability slots and bookings needed for testing booking flows.

**Why This Matters:**
- Developers need realistic test data to work on booking features locally
- Without availability slots, mentees can't test browsing/booking flows
- Without existing bookings, dashboard and calendar features show empty states
- Dynamic date generation ensures test data is always "upcoming" (not expired)
- Separate availability and booking seed files allow independent re-seeding

**Story Boundaries:**
- ✅ Create seed data for availability blocks and bookings
- ✅ Update production seed files to match (same dynamic date logic)
- ✅ Fix user seed files for local development (ETL disabled for users)
- ✅ Separate availability and booking generation for clarity
- ❌ NO changes to database schema (already defined in migrations)
- ❌ NO changes to API or frontend (this is pure data seeding)
- ❌ NO production email updates (special emails not provided)

### Testing Results

**Seed Data Verification (Local):**
```
Users: 400 mentors, 50 mentees, 2 coordinators
Availability: 1200 blocks (400 mentors × 3 weeks)
Time Slots: 1200 total (600 available, 600 booked)
Bookings: 600 total (309 pending, 291 confirmed)
Booking percentage: 50.00% ✓
```

All acceptance criteria met! ✅

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-07 | 0.1 | Initial story created for enhanced seed data | Bob (Scrum Master) |
| 2025-10-07 | 0.2 | Story completed with full implementation | James (Dev Agent) |

---

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None required - implementation followed story requirements with schema adjustments

### Completion Notes List

**Implementation Summary:**

1. **User Seed Fixes** - ETL triggers disabled for users, so seeds create users directly:
   - Updated 04_seed_mentees.sql (50 mentees)
   - Updated 05_seed_users.sql (2 coordinators)
   - Updated 06_seed_mentors.sql (400 mentors)

2. **Availability & Time Slots** - New file 07_seed_availability.sql:
   - ALL 400 mentors (not limited to 10)
   - 1200 availability blocks (400 × 3 weeks)
   - Dynamic date generation (NOW() + intervals)
   - Random times 8am-8pm, durations 15/30/60 min
   - 1200 time slots generated

3. **Bookings** - New file 08_seed_bookings.sql (separate from availability):
   - 600 bookings (50% of slots)
   - ALL 50 mentees used (not limited)
   - 50/50 status split: 309 pending, 291 confirmed
   - Random meeting goals from predefined templates

4. **Production Seeds** - Created matching production files:
   - 07_seed_raw_availability.sql
   - 08_seed_raw_bookings.sql
   - Updated seed_all_production.sql orchestration

**Schema Adjustments Made:**
- Duration: Changed 45min to 15min (schema constraint: 15, 20, 30, 60)
- Bookings: Added location, meeting_start_time, meeting_end_time (required fields)
- Users: Used deleted_by instead of deleted_at for soft deletes

**Testing:**
- Database reset verified all data created successfully
- All acceptance criteria verified with SQL queries

### File List

**New Files:**
- supabase/seeds/07_seed_availability.sql
- supabase/seeds/08_seed_bookings.sql
- supabase/seeds/production/07_seed_raw_availability.sql
- supabase/seeds/production/08_seed_raw_bookings.sql

**Modified Files:**
- supabase/seeds/04_seed_mentees.sql
- supabase/seeds/05_seed_users.sql
- supabase/seeds/06_seed_mentors.sql
- supabase/seeds/production/seed_all_production.sql

---

## QA Results

_To be populated by QA agent after story completion_
